<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備溫度監控</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .device-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 280px;
            text-align: center;
        }
        h2 {
            color: #007BFF;
            margin-bottom: 10px;
        }
        p {
            font-size: 1.8em;
            font-weight: bold;
            color: #28a745; /* 綠色表示正常溫度 */
        }
        .high-temp {
            color: #dc3545; /* 紅色表示高溫警示 */
        }
    </style>
</head>
<body>
    <h1>即時設備溫度顯示</h1>
    <div class="container" id="device-container">
        </div>

    <script>
        // 您提供的 JavaScript 程式碼，請完整放在這裡
        const API_URL = 'http://211.72.66.34:3001/read?topic=P';
        const UPDATE_INTERVAL_MS = 5000; // 每 5 秒更新一次

        async function fetchTemperatureData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateDisplay(data);
            } catch (error) {
                console.error('Fetch error:', error);
                // 可以顯示錯誤訊息給使用者
                document.getElementById('device-container').innerHTML = '<p style="color: red;">無法取得溫度資料，請檢查API連線。</p>';
            }
        }

        function updateDisplay(data) {
            const container = document.getElementById('device-container');
            container.innerHTML = ''; // 清空舊內容
            let highTempExists = false; // 用於判斷是否有高溫

            for (const deviceId in data) {
                if (data.hasOwnProperty(deviceId)) {
                    const temp = data[deviceId].AO[0]; // 取得溫度值
                    const card = document.createElement('div');
                    card.className = 'device-card';

                    // 假設 70 度以上為高溫警示 (排除異常大值)
                    const tempClass = (temp > 70 && temp < 3000) ? 'high-temp' : '';
                    if (tempClass === 'high-temp') {
                        highTempExists = true;
                    }

                    card.innerHTML = `
                        <h2>${deviceId}</h2>
                        <p class="${tempClass}">${temp !== 3276.7 ? temp.toFixed(1) : '異常' } °C</p>
                        `;
                    container.appendChild(card);
                }
            }

            // 如果有高溫，可以在這裡顯示一個總體警示
            if (highTempExists) {
                // 例如：在頁面頂部加一個警示條
            }
        }

        // 頁面載入後立即執行一次
        fetchTemperatureData();
        // 設定定時器，每隔一段時間更新一次
        setInterval(fetchTemperatureData, UPDATE_INTERVAL_MS);
    </script>
</body>
</html>